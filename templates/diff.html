<html>
    <head>
    </head>
    <body>

    </body>
        <h1>clan diff</h1>

        <h2>Report A run {{ diff.a.run_date }}</h2>

        <dl>
            {% for arg in GLOBAL_ARGUMENTS %} 
            <dt>{{ arg }}</dt><dd>{{ diff.a[arg] }}</dd>
            {% endfor %}
        </dl>

        <h2>Report B run {{ diff.b.run_date }}</h2>

        <dl>
            {% for arg in GLOBAL_ARGUMENTS %} 
            <dt>{{ arg }}</dt><dd>{{ diff.b[arg] }}</dd>
            {% endfor %}
        </dl>

        <h2>Results</h2>

        {% for query in diff['queries'] %}
            <h3>{{ query.config.name }}</h3>

            {% for metric, data in query.data.items() %}
                <h4>{{ metric }}</h4>

                <table>
                    <tr>
                        <th>Value change</th>
                        <th>Percent change</th>
                        <th>Percentage point change</th>
                        <th>Label</th>
                    </tr>
                    {% for label, values in data.items() %}
                    <tr>
                        {% set a = values.a %}
                        {% set b = values.b %}
                        {% set change = b - a %}
                        {% set data_type = query.data_types[metric] %}
                        {% set totals = data.total %}

                        {% if data_type == 'INTEGER' %}
                            {% if totals.a == 0 %}
                                {% set pct_a = None %}
                            {% else %}
                                {% set pct_a = a / totals.a %}
                            {% endif %}

                            {% if totals.b == 0 %}
                                {% set pct_b = 0 %}
                            {% else %}
                                {% set pct_b = b / totals.b %}
                            {% endif %} 

                            <th>{{ format_comma(change) }}</th>
                            <th>
                                {% if a == 0 %}
                                    -
                                {% else %}
                                    {{ format_percent(change, a) }}
                                {% endif %}
                            </th>
                            <th>
                                {% if label == 'total' or pct_a == None or pct_b == None %}
                                    -
                                {% else %}
                                {{ '{:.1f}'.format((pct_b - pct_a) * 100) }}
                                {% endif %}
                            </th>
                        {% elif data_type == 'TIME' %}
                            <th>{{ format_duration(change) }}</th>
                            <th>
                                {% if a == 0 %}
                                    -
                                {% else %}
                                    {{ format_percent(change, a) }}
                                {% endif %}
                            </th>
                            <th>-</th>
                        {% else %}
                            <th>{{ '{:.1f}'.format(change) }}</th>
                            <th>
                                {% if a == 0 %}
                                    -
                                {% else %}
                                    {{ format_percent(change, a) }}
                                {% endif %}
                            </th>
                            <th>-</th>
                        {% endif %}

                        <th>{{ label }}</th>
                    </tr>
                    {% endfor %}
                </table>
            {% endfor %}
        {% endfor %}
    </body>
</html>
